{% extends "base.html" %}

{% block title %}Метрики{% endblock %}

{% block head_extra %}
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
  <div class="top">
    <h1>Метрики</h1>
    <div class="actions">
      <a class="btn" href="/ui/metrics.csv">Экспорт CSV</a>
      <a class="btn ghost" href="/ui/metrics.pdf">Экспорт PDF</a>
    </div>
  </div>

  <div class="row">
    <div class="box">
      <h3 style="margin:0;">Uptime (24ч) по каждому сайту</h3>
      <div class="chart-holder"><canvas id="uptimeChart" width="600" height="360"></canvas></div>
    </div>
    <div class="box">
      <div class="controls">
        <h3 style="margin:0;">Недавние задержки</h3>
        <select id="site-select"></select>
      </div>
      <div class="stats">
        <div class="stat"><div class="label">p50</div><div class="value" id="p50">—</div></div>
        <div class="stat"><div class="label">p95</div><div class="value" id="p95">—</div></div>
        <div class="stat"><div class="label">p99</div><div class="value" id="p99">—</div></div>
        <div class="stat"><div class="label">Частота ошибок</div><div class="value" id="err">—</div></div>
      </div>
      <div class="chart-holder"><canvas id="latencyChart" width="600" height="360"></canvas></div>
    </div>
  </div>

  <div class="row">
    <div class="box">
      <h3 style="margin:0;">Частота ошибок (последние 100 проверок)</h3>
      <div class="chart-holder"><canvas id="errorChart" width="600" height="360"></canvas></div>
    </div>
  </div>
{% endblock %}

{% block scripts_extra %}
  <script>
    const labels = {{ labels | tojson }};
    const uptimeValues = {{ uptime_values | tojson }};
    const errorRates = {{ error_rates | tojson }};
    const latencySeries = {{ latency_series | tojson }};

    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    const ctx = document.getElementById('uptimeChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Uptime % (24h)',
          data: uptimeValues,
          backgroundColor: 'rgba(56,189,248,0.6)',
          borderRadius: 8,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}}
    });

    const errCtx = document.getElementById('errorChart').getContext('2d');
    new Chart(errCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Error rate % (last 100 checks)',
          data: errorRates,
          backgroundColor: 'rgba(248,113,113,0.7)',
          borderRadius: 8,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}}
    });

    const ctx2 = document.getElementById('latencyChart').getContext('2d');
    const selectEl = document.getElementById('site-select');

    const fmtLabels = (arr) => arr.map(ts => new Date(ts).toLocaleString(undefined, {
      year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'
    }));

    const percentile = (arr, p) => {
      if(!arr.length) return null;
      const sorted = [...arr].sort((a,b)=>a-b);
      const idx = (sorted.length - 1) * (p/100);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      if(lo === hi) return sorted[lo];
      return sorted[lo] + (sorted[hi]-sorted[lo]) * (idx - lo);
    };

    const updateStats = (series) => {
      const vals = series.values || [];
      const statuses = series.statuses || [];
      const p50El = document.getElementById('p50');
      const p95El = document.getElementById('p95');
      const p99El = document.getElementById('p99');
      const errEl = document.getElementById('err');
      const set = (el, val, suffix=' ms') => { el.textContent = val === null ? '—' : `${Math.round(val)}${suffix}`; };
      set(p50El, percentile(vals, 50));
      set(p95El, percentile(vals, 95));
      set(p99El, percentile(vals, 99));
      const errs = statuses.filter(s => s && s !== 'UP').length;
      const rate = statuses.length ? (errs / statuses.length) * 100 : null;
      errEl.textContent = rate === null ? '—' : `${rate.toFixed(1)}%`;
    };

    latencySeries.forEach((s, idx) => {
      const opt = document.createElement('option');
      opt.value = s.site_id;
      opt.textContent = s.site_name || `Site ${idx+1}`;
      selectEl.appendChild(opt);
    });

    function getSeries(id){
      return latencySeries.find(s => s.site_id === id) || latencySeries[0] || {labels:[], values:[]};
    }

    let current = getSeries(latencySeries[0]?.site_id);
    updateStats(current);
    const latencyChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: fmtLabels(current.labels),
        datasets: [{
          label: 'Latency ms',
          data: current.values,
          borderColor: 'rgba(94,234,212,0.9)',
          backgroundColor: 'rgba(94,234,212,0.18)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
    });

    selectEl.addEventListener('change', () => {
      current = getSeries(selectEl.value);
      latencyChart.data.labels = fmtLabels(current.labels);
      latencyChart.data.datasets[0].data = current.values;
      latencyChart.update();
    });
  </script>
{% endblock %}
