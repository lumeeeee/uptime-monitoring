<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metrics</title>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap');
    :root{
      --bg: #0f172a;
      --panel: #0b1220;
      --surface: rgba(255,255,255,0.02);
      --text: #e5e7eb;
      --muted: #94a3b8;
      --accent: #38bdf8;
      --accent-strong: #0ea5e9;
      --border: #0a0f1a;
      --radius: 14px;
      --sidebar-w: 260px;
      --sidebar-bg: #0b1220;
      --sidebar-border: #0a0f1a;
    }
    body{margin:0; padding:28px; padding-left: 32px; background: radial-gradient(circle at 18% 10%, rgba(56,189,248,0.08), transparent 30%), radial-gradient(circle at 82% 8%, rgba(14,165,233,0.1), transparent 32%), var(--bg); color: var(--text); font-family: 'Space Grotesk','Inter',system-ui,sans-serif; transition: padding-left .2s ease;}
    .page{max-width:1200px;margin:0 auto;}
    .sidebar { position: fixed; inset:0 auto 0 0; width: var(--sidebar-w); background: linear-gradient(180deg, rgba(15,23,42,0.96), rgba(11,18,32,0.98)); border-right:1px solid var(--sidebar-border); padding:24px 18px; box-shadow: 6px 0 30px rgba(0,0,0,0.28); display:flex; flex-direction:column; gap:16px; z-index:50; transform: translateX(-100%); transition: transform .25s ease; }
    .sidebar .logo { font-weight:700; letter-spacing:-0.01em; display:flex; align-items:center; gap:10px; font-size:16px; }
    .sidebar nav { display:flex; flex-direction:column; gap:6px; }
    .sidebar nav a { display:flex; align-items:center; gap:10px; padding:10px 12px; border-radius:12px; color: var(--text); text-decoration:none; border:1px solid transparent; transition: background .12s ease, border-color .12s ease; }
    .sidebar nav a span { font-weight:600; font-size:14px; }
    .sidebar nav a.active { background: rgba(56,189,248,0.12); border-color: rgba(56,189,248,0.35); color: var(--accent); }
    .sidebar nav a:hover { background: rgba(255,255,255,0.05); border-color: rgba(255,255,255,0.08); }
    .nav-toggle { position: fixed; top:18px; left:18px; width:42px; height:42px; border-radius:12px; border:1px solid var(--border); background: rgba(255,255,255,0.04); color: var(--text); display:flex; align-items:center; justify-content:center; cursor:pointer; z-index:60; box-shadow:0 10px 28px rgba(0,0,0,0.25); }
    .sidebar-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.45); opacity:0; pointer-events:none; transition: opacity .2s ease; z-index:40; }
    body.sidebar-open .sidebar-overlay { opacity:1; pointer-events:auto; }
    body.sidebar-open .sidebar { transform: translateX(0); }
    .top{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:18px;}
    h1{margin:0;font-size:26px;letter-spacing:-0.01em;}
    .theme-toggle{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:10px 12px;border-radius:12px;cursor:pointer;}
    .row{display:flex;gap:18px;align-items:stretch;flex-wrap:wrap;}
    .box{flex:1;min-width:320px; background: linear-gradient(150deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); border:1px solid var(--border); border-radius: var(--radius); padding:16px; box-shadow: 0 14px 40px rgba(0,0,0,0.25); position:relative; overflow:hidden; }
    .box::before{content:"";position:absolute;inset:0;background: radial-gradient(circle at 20% 15%, rgba(56,189,248,0.14), transparent 45%);opacity:0;transition:opacity .2s ease;pointer-events: none;}
    .box:hover::before{opacity:1;}
    .chart-holder{position:relative;width:100%;height:360px;margin-top:10px;}
    canvas{position:absolute;inset:0;width:100% !important;height:100% !important}
    .controls{display:flex;align-items:center;gap:10px;margin-bottom:4px;}
    select{padding:8px 10px;border-radius:10px;border:1px solid var(--border);background:var(--panel);color:var(--text);}
    .stats{display:grid;grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap:10px; margin-bottom:14px;}
    .stat{padding:12px; border:1px solid var(--border); border-radius:12px; background: rgba(255,255,255,0.02); display:flex; flex-direction:column; gap:6px;}
    .stat .label{color:var(--muted); font-size:12px; letter-spacing:0.01em;}
    .stat .value{font-weight:700; font-size:18px;}
    .actions{display:flex; gap:10px; align-items:center;}
    .btn{padding:10px 14px; border-radius:10px; border:1px solid var(--border); background: linear-gradient(135deg, var(--accent), var(--accent-strong)); color:#0b1220; font-weight:700; text-decoration:none; box-shadow:0 10px 28px rgba(56,189,248,0.25); transition: transform .08s ease, box-shadow .12s ease;}
    .btn:hover{transform: translateY(-1px); box-shadow:0 14px 34px rgba(56,189,248,0.32);}
    .btn.ghost{background: transparent; color: var(--text); border-color: var(--border); box-shadow:none;}
    .btn.ghost:hover{border-color: var(--accent); color: var(--text);}
    @media(min-width:1025px){
      body { padding-left: calc(var(--sidebar-w) + 28px); }
      .sidebar { transform: translateX(0); }
    }
    @media(max-width:1024px){
      body { padding-left:28px; }
      .sidebar { transform: translateX(-100%); }
    }
    @media(max-width:900px){.row{flex-direction:column}}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <button class="nav-toggle" aria-label="–ú–µ–Ω—é" type="button">‚ò∞</button>
  <div class="sidebar">
    <div class="logo">üî≠ Uptime</div>
    <nav>
      <a class="nav-link" data-path="/ui" href="/ui"><span>–ü–∞–Ω–µ–ª—å</span></a>
      <a class="nav-link" data-path="/ui/metrics" href="/ui/metrics"><span>–ú–µ—Ç—Ä–∏–∫–∏</span></a>
      <a class="nav-link" data-path="/admin/sites" href="/admin/sites"><span>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ</span></a>
    </nav>
  </div>
  <div class="sidebar-overlay"></div>
  <div class="page">
    <div class="top">
      <h1>–ú–µ—Ç—Ä–∏–∫–∏</h1>
      <div class="actions">
        <a class="btn" href="/ui/metrics.csv">–≠–∫—Å–ø–æ—Ä—Ç CSV</a>
        <a class="btn ghost" href="/ui/metrics.pdf">–≠–∫—Å–ø–æ—Ä—Ç PDF</a>
      </div>
    </div>

    <div class="row">
      <div class="box">
        <h3 style="margin:0;">Uptime (24—á) –ø–æ –∫–∞–∂–¥–æ–º—É —Å–∞–π—Ç—É</h3>
        <div class="chart-holder"><canvas id="uptimeChart" width="600" height="360"></canvas></div>
      </div>
      <div class="box">
        <div class="controls">
          <h3 style="margin:0;">–ù–µ–¥–∞–≤–Ω–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏</h3>
          <select id="site-select"></select>
        </div>
        <div class="stats">
          <div class="stat"><div class="label">p50</div><div class="value" id="p50">‚Äî</div></div>
          <div class="stat"><div class="label">p95</div><div class="value" id="p95">‚Äî</div></div>
          <div class="stat"><div class="label">p99</div><div class="value" id="p99">‚Äî</div></div>
          <div class="stat"><div class="label">–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫</div><div class="value" id="err">‚Äî</div></div>
        </div>
        <div class="chart-holder"><canvas id="latencyChart" width="600" height="360"></canvas></div>
      </div>
    </div>

    <div class="row">
      <div class="box">
        <h3 style="margin:0;">–ß–∞—Å—Ç–æ—Ç–∞ –æ—à–∏–±–æ–∫ (–ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 –ø—Ä–æ–≤–µ—Ä–æ–∫)</h3>
        <div class="chart-holder"><canvas id="errorChart" width="600" height="360"></canvas></div>
      </div>
    </div>
  </div>

  <script>
    (function(){
      const toggle = document.querySelector('.nav-toggle');
      const overlay = document.querySelector('.sidebar-overlay');
      const body = document.body;
      const open = () => body.classList.add('sidebar-open');
      const close = () => body.classList.remove('sidebar-open');
      toggle?.addEventListener('click', () => body.classList.contains('sidebar-open') ? close() : open());
      overlay?.addEventListener('click', close);
      window.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') close(); });
      const path = window.location.pathname;
      document.querySelectorAll('.nav-link').forEach(link => {
        const base = link.dataset.path;
        if(path === base || path.startsWith(base + '/') || (base === '/ui' && (path === '/' || path === '/ui'))){
          link.classList.add('active');
        }
      });
    })();
  </script>
  <script>
    const labels = {{ labels | tojson }};
    const uptimeValues = {{ uptime_values | tojson }};
    const errorRates = {{ error_rates | tojson }};
    const latencySeries = {{ latency_series | tojson }};

    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    const ctx = document.getElementById('uptimeChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Uptime % (24h)',
          data: uptimeValues,
          backgroundColor: 'rgba(56,189,248,0.6)',
          borderRadius: 8,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}}
    });

    const errCtx = document.getElementById('errorChart').getContext('2d');
    new Chart(errCtx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Error rate % (last 100 checks)',
          data: errorRates,
          backgroundColor: 'rgba(248,113,113,0.7)',
          borderRadius: 8,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}}
    });

    const ctx2 = document.getElementById('latencyChart').getContext('2d');
    const selectEl = document.getElementById('site-select');

    const fmtLabels = (arr) => arr.map(ts => new Date(ts).toLocaleString(undefined, {
      year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'
    }));

    const percentile = (arr, p) => {
      if(!arr.length) return null;
      const sorted = [...arr].sort((a,b)=>a-b);
      const idx = (sorted.length - 1) * (p/100);
      const lo = Math.floor(idx), hi = Math.ceil(idx);
      if(lo === hi) return sorted[lo];
      return sorted[lo] + (sorted[hi]-sorted[lo]) * (idx - lo);
    };

    const updateStats = (series) => {
      const vals = series.values || [];
      const statuses = series.statuses || [];
      const p50El = document.getElementById('p50');
      const p95El = document.getElementById('p95');
      const p99El = document.getElementById('p99');
      const errEl = document.getElementById('err');
      const set = (el, val, suffix=' ms') => { el.textContent = val === null ? '‚Äî' : `${Math.round(val)}${suffix}`; };
      set(p50El, percentile(vals, 50));
      set(p95El, percentile(vals, 95));
      set(p99El, percentile(vals, 99));
      const errs = statuses.filter(s => s && s !== 'UP').length;
      const rate = statuses.length ? (errs / statuses.length) * 100 : null;
      errEl.textContent = rate === null ? '‚Äî' : `${rate.toFixed(1)}%`;
    };

    latencySeries.forEach((s, idx) => {
      const opt = document.createElement('option');
      opt.value = s.site_id;
      opt.textContent = s.site_name || `Site ${idx+1}`;
      selectEl.appendChild(opt);
    });

    function getSeries(id){
      return latencySeries.find(s => s.site_id === id) || latencySeries[0] || {labels:[], values:[]};
    }

    let current = getSeries(latencySeries[0]?.site_id);
    updateStats(current);
    const latencyChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: fmtLabels(current.labels),
        datasets: [{
          label: 'Latency ms',
          data: current.values,
          borderColor: 'rgba(94,234,212,0.9)',
          backgroundColor: 'rgba(94,234,212,0.18)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
    });

    selectEl.addEventListener('change', () => {
      current = getSeries(selectEl.value);
      latencyChart.data.labels = fmtLabels(current.labels);
      latencyChart.data.datasets[0].data = current.values;
      latencyChart.update();
    });
  </script>
</body>
</html>
