<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Metrics</title>
  <style>
    body{font-family:Arial, sans-serif; margin:24px; background:var(--bg, #f7f9fb); color:var(--text,#1f2933)}
    h1{margin-bottom:12px}
    .page{max-width:1200px;margin:0 auto;}
    .row{display:flex;gap:20px;align-items:flex-start;flex-wrap:wrap}
    .box{background:#fff;padding:16px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);flex:1;min-width:320px}
    .chart-holder{position:relative;width:100%;height:360px;}
    canvas{position:absolute;inset:0;width:100% !important;height:100% !important}
    @media(max-width:900px){.row{flex-direction:column}}
    .controls{margin-bottom:8px;display:flex;align-items:center;gap:8px;}
    select{padding:6px 8px;border-radius:6px;border:1px solid #cbd5e1;}
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <div class="page">
  <h1>Metrics</h1>
  <div class="row">
    <div class="box">
      <h3>Uptime (24h) per site</h3>
      <div class="chart-holder"><canvas id="uptimeChart" width="600" height="360"></canvas></div>
    </div>
    <div class="box">
      <div class="controls">
        <h3 style="margin:0;">Recent latencies</h3>
        <select id="site-select"></select>
      </div>
      <div class="chart-holder"><canvas id="latencyChart" width="600" height="360"></canvas></div>
    </div>
  </div>
  </div>

  <script>
    const labels = {{ labels | tojson }};
    const uptimeValues = {{ uptime_values | tojson }};
    const latencySeries = {{ latency_series | tojson }};

    Chart.defaults.responsive = true;
    Chart.defaults.maintainAspectRatio = false;
    const ctx = document.getElementById('uptimeChart').getContext('2d');
    new Chart(ctx, {
      type: 'bar',
      data: {
        labels: labels,
        datasets: [{
          label: 'Uptime % (24h)',
          data: uptimeValues,
          backgroundColor: 'rgba(37,99,235,0.7)'
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true, max:100}}}
    });

    const ctx2 = document.getElementById('latencyChart').getContext('2d');
    const selectEl = document.getElementById('site-select');

    const fmtLabels = (arr) => arr.map(ts => new Date(ts).toLocaleString(undefined, {
      year:'numeric', month:'short', day:'2-digit', hour:'2-digit', minute:'2-digit'
    }));

    // populate select
    latencySeries.forEach((s, idx) => {
      const opt = document.createElement('option');
      opt.value = s.site_id;
      opt.textContent = s.site_name || `Site ${idx+1}`;
      selectEl.appendChild(opt);
    });

    function getSeries(id){
      return latencySeries.find(s => s.site_id === id) || latencySeries[0] || {labels:[], values:[]};
    }

    let current = getSeries(latencySeries[0]?.site_id);
    const latencyChart = new Chart(ctx2, {
      type: 'line',
      data: {
        labels: fmtLabels(current.labels),
        datasets: [{
          label: 'Latency ms',
          data: current.values,
          borderColor: 'rgba(16,185,129,0.9)',
          backgroundColor: 'rgba(16,185,129,0.15)',
          fill: true,
          tension: 0.3,
        }]
      },
      options: {responsive:true, maintainAspectRatio:false, scales:{y:{beginAtZero:true}}}
    });

    selectEl.addEventListener('change', () => {
      current = getSeries(selectEl.value);
      latencyChart.data.labels = fmtLabels(current.labels);
      latencyChart.data.datasets[0].data = current.values;
      latencyChart.update();
    });
  </script>
</body>
</html>
